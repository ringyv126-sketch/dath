# 1. Tạo thư mục workspace (nếu chưa có)
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws/src

# 2. Tạo package python
ros2 pkg create --build-type ament_python thermal_camera_pkg --dependencies rclpy sensor_msgs cv_bridge

pip install opencv-python numpy
sudo apt install ros-humble-cv-bridge ros-humble-vision-opencv

cd ~/ros2_ws/src/thermal_camera_pkg/thermal_camera_pkg
touch thermal_node.py
chmod +x thermal_node.py
nano thermal_node.py

#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from sensor_msgs.msg import Image
from cv_bridge import CvBridge
import cv2
import numpy as np
import board
import busio
import adafruit_mlx90640

class ThermalCameraNode(Node):
    def __init__(self):
        super().__init__('thermal_camera_node')
        
        # --- CẤU HÌNH ---
        self.target_fps = 2.0  # Giữ thấp để tránh quá tải I2C
        self.temp_threshold = 60.0
        
        # --- KHỞI TẠO PUBLISHER ---
        self.publisher_ = self.create_publisher(Image, 'thermal_image', 10)
        
        # --- KHỞI TẠO PHẦN CỨNG ---
        # Tự động dùng frequency mặc định của hệ thống (đã set trong config.txt)
        self.i2c = busio.I2C(board.SCL, board.SDA)
        
        try:
            self.mlx = adafruit_mlx90640.MLX90640(self.i2c)
            self.mlx.refresh_rate = adafruit_mlx90640.RefreshRate.REFRESH_2_HZ
        except Exception as e:
            self.get_logger().error(f'Khong the ket noi MLX90640: {str(e)}')
            # Nếu không kết nối được, node vẫn chạy nhưng không làm gì để tránh crash
            self.mlx = None

        self.frame = [0] * 768
        self.bridge = CvBridge()
        
        # Timer
        self.timer = self.create_timer(1.0 / self.target_fps, self.timer_callback)
        self.get_logger().info('Thermal Camera Node started (2Hz Mode)')

    def timer_callback(self):
        if self.mlx is None:
            return # Nếu camera chưa init được thì bỏ qua

        try:
            # 1. Đọc dữ liệu (Có bắt lỗi Retry)
            try:
                self.mlx.getFrame(self.frame)
            except RuntimeError:
                # Lỗi này do đọc chậm hơn ghi -> Bỏ qua frame này, chờ frame sau
                return 
            except ValueError:
                return

            # 2. Xử lý logic an toàn
            max_temp = max(self.frame)
            if max_temp > self.temp_threshold:
                self.get_logger().warn(f'CẢNH BÁO QUÁ NHIỆT: {max_temp:.1f} độ C!')

            # 3. Xử lý ảnh
            data_array = np.array(self.frame).reshape((24, 32))
            
            min_val = np.min(data_array)
            max_val = np.max(data_array)
            
            if max_val == min_val:
                norm_img = np.zeros_like(data_array, dtype=np.uint8)
            else:
                norm_img = (data_array - min_val) / (max_val - min_val) * 255
                norm_img = norm_img.astype(np.uint8)
            
            # Phóng to
            status_img = cv2.resize(norm_img, (640, 480), interpolation=cv2.INTER_CUBIC)
            # Tô màu
            color_img = cv2.applyColorMap(status_img, cv2.COLORMAP_JET)
            
            # 4. Gửi lên ROS
            msg = self.bridge.cv2_to_imgmsg(color_img, encoding="bgr8")
            msg.header.stamp = self.get_clock().now().to_msg()
            msg.header.frame_id = "thermal_frame" 
            
            self.publisher_.publish(msg)

        except Exception as e:
            self.get_logger().error(f'System Error: {str(e)}')

def main(args=None):
    rclpy.init(args=args)
    node = ThermalCameraNode()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()

nano ~/ros2_ws/src/thermal_camera_pkg/setup.py

entry_points={
        'console_scripts': [
            'thermal_node = thermal_camera_pkg.thermal_node:main',
        ],
    },

cd ~/ros2_ws
colcon build --packages-select thermal_camera_pkg --symlink-install
source install/setup.bash

ros2 run thermal_camera_pkg thermal_node
